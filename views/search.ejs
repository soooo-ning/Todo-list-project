<!DOCTYPE html>
<html lang="en">
  <%- include('include/header', { title: 'search' }) %>
  <body>
    <nav class="nav"><%- include('include/navi') %></nav>

    <main class="container search_wrap">
      <div class="content">
        <h3 class="sub_title">
          <span
            ><i class="search_tit"
              >"<%= searchQuery ? `${searchQuery}` : ' ' %>"</i
            >
            검색 결과</span
          >
        </h3>

        <!-- <h3 class="sub_title"><span>검색 결과</span></h3> -->
        <div class="card-container add" id="cardContainer"></div>
      </div>
    </main>

    <%- include('include/write-popup') %> <%- include('include/detail-popup') %>

    <script>
      async function searchTodos(query) {
        try {
          const response = await fetch(
            `/todo/api/search?query=${encodeURIComponent(query)}`,
          );
          const result = await response.json();

          const cardContainer = document.getElementById('cardContainer');

          if (result.status === 'success') {
            if (!result.data || result.data.length === 0) {
              cardContainer.innerHTML =
                '<p class="no-results">검색 결과가 없습니다.</p>';
              return;
            }

            const html = result.data
              .map((todo) => {
                return `
                <div class="card">
                  <div class="card-title">${todo.title}</div>
                  <ul class="todo-list-all">
                    ${(todo.todo_contents || [])
                      .map(
                        (content) => `
                      <li class="${content.state ? 'completed' : ''}">${
                          content.content
                        }</li>
                    `,
                      )
                      .join('')}
                  </ul>
                </div>
              `;
              })
              .join('');

            cardContainer.innerHTML = html;
            // 카드 클릭
            document.querySelectorAll('.card').forEach((card) => {
              card.addEventListener('click', () => {
                const id = card.getAttribute('data-id');
                if (id) {
                  window.location.href = `/todo/api/get/${id}`;
                }
              });
            });
          } else {
            cardContainer.innerHTML =
              '<p class="error">검색 결과를 불러오는데 실패했습니다.</p>';
          }
        } catch (error) {
          console.error('검색 오류:', error);
          document.getElementById('cardContainer').innerHTML =
            '<p class="error">검색 중 오류가 발생했습니다.</p>';
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const query = urlParams.get('query');

        if (query) {
          const searchInput = document.getElementById('search-comment');
          if (searchInput) {
            searchInput.value = query;
          }

          searchTodos(query);
        }
      });
    </script>
  </body>
</html>
